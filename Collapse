package com.example.rewrite;

import org.openrewrite.ExecutionContext;
import org.openrewrite.Recipe;
import org.openrewrite.java.JavaVisitor;
import org.openrewrite.java.tree.Expression;
import org.openrewrite.java.tree.J;

import java.util.List;

public class MergeNestedIfsRecipe extends Recipe {

    @Override
    public String getDisplayName() {
        return "Merge nested if statements (Sonar S1066)";
    }

    @Override
    public String getDescription() {
        return "Collapses nested if-statements into a single if with combined conditions using &&.";
    }

    @Override
    public JavaVisitor<ExecutionContext> getVisitor() {
        return new JavaVisitor<ExecutionContext>() {
            @Override
            public J visitIf(J.If ifStmt, ExecutionContext ctx) {
                J.If i = (J.If) super.visitIf(ifStmt, ctx);

                // ensure body has exactly one statement
                if (i.getThenPart() instanceof J.Block) {
                    J.Block thenBlock = (J.Block) i.getThenPart();
                    List<J> statements = thenBlock.getStatements();

                    if (statements.size() == 1 && statements.get(0) instanceof J.If) {
                        J.If nested = (J.If) statements.get(0);

                        // ✅ merge conditions: (outer && inner)
                        Expression mergedCondition = new J.Binary(
                                randomId(),
                                i.getIfCondition().getTree(),
                                J.Binary.Type.And,
                                nested.getIfCondition().getTree(),
                                i.getIfCondition().getTree().getPrefix(),
                                i.getIfCondition().getTree().getMarkers(),
                                null
                        );

                        // ✅ reuse inner's then-part, keep outer's else as-is
                        return i.withIfCondition(i.getIfCondition().withTree(mergedCondition))
                                .withThenPart(nested.getThenPart());
                    }
                }
                return i;
            }
        };
    }
}
